# 爱房测试环境代理服务

# 工作流程？

爱房测试环境是一个独立的内网域名，直接指向 nginx，在通过 loaction/upstream 进行路由转发到具体的服务集群中。
经过我的改造，现在是内网域名指向 nginx，直接 loaction 到我的代理服务中，也就是 node 服务，在这里进行请求的转发和管理。当然 nginx 层理论上可以去掉，但是集团规定不允许这么做，所以就只好留着他。
node 服务这里得知道一个请求要往哪里转发，首先得有一个 mapping 关系，这个关系在 nginx 上的体现就是 location/upstream，upstream 对应的是一组 ip 地址。那么 node 服务也得有这样的一层关系，但是 nginx 的配置文件被我改掉了，所以我只能去读线上环境的 ng 配置然后自己解析一下，拿到 loaction + 集群名称的 mapping。
58 集团云平台的一个集群有四个环境，其中线下的有测试环境的稳定环境，这两个之间的区别是稳定环境的 ip 是固定不变的。那么当 node 服务接收到一个请求的时候，默认根据 mapping 关系将这个请求转发到稳定环境的机器 ip 上就好(这里我需要通过云平台的 api 来查询机器都有哪些)。这是最基本的工作流程。

关键点在：node 服务会记录请求者的 ip 和 UA(UserAgent)，并把它当作设备指纹，同时对外提供一个 api 接口，接口参数是集群名与机器 ip。当这个接口被请求的时候，会解析拿到集群与 ip 并记录到指纹对应的配置中，那么接下来当这台机器发起的一些业务接口，在到达 node 服务时，会先根据指纹拿到配置好的 ip 后，再进行转发。这样我们就实现了一个公用的反向代理服务，因为是单机服务甚至不需要 redis，测试环境根本么那么多人用，前端部门 30 个，后端 20 个，测试 20 个，也不需要去考虑证书，因为是集团 nginx 统一配置的测试证书。

为了进一步提供便利性，访问根路径时会返回控制台面板，可以看到当前都有哪些配置。在面板这里还可以进行 url 或者是扫码分享，可以复制一下 url 发给测试，当测试访问 url 的时候 node 服务就会生成一个新的设备指纹和配置项。这样开发和测试就可以很便捷的再各个环境之间切换。我可以给你演示一下。

# 问题？

第一版的问题其实不是特别多，因为是我闲着没事的时候开发的，而且我当时不知道到底能不能把这个工具用起来。但是后来测试团队的老板觉得价值很高，然后就催着我老板期望能够做的更精致一点，好推广到其他部门，所以就开始了第二版的开发。
我现在正在短短续续的进行重构工作。然后我列了几个问题点，都是还没有解决的。你想听听吗？

1. 第一个点，控制面板的启动方式，现在是通过根路径打开，但是业务场景五花八门，根路径恐怕已经被占用了，新开一个特殊的路径也不能保证是通用的，有记忆成本，开发者得记住控制面板要怎么打开才行，我想的是在 node 服务中劫持 html 请求，并在他里面加点料，其实就是运营商劫持。
2. 第二个点是目前 node 服务仅支持单机应用，如果推广到其他部门，可能单机性能不够。同时我又觉得这些不同产品线的应用不应该共用代理服务，所以我应该为每条产品线单独部署一个稳定的 ip，这样既不需要引入 redis, 也不需要考虑性能问题，只要让他们的 nginx 指向固定的 ip 就好。
3. 第三个点是服务之间互相调用的问题，目前仅支持第一层请求调用，如果服务之间互相调用的话做不到链路的统一，这个问题比较棘手，微服务或者是 bff 服务可能会遇到这个问题，我还没想好怎么解决。
4. 前端方面的交互要调整，还要再加一个历史记录，方便查看历史配置。
5. nginx 配置里面不一定都是简单的路由转发配置，还有可能有一些特别的逻辑，这种情况下没有办法做到完全代理，但这种情况目前还没有遇到，所以优先级不高。

我重构后的版本有个小 demo，也可以给你演示一下。比较可惜的是，我好不容易找了一个热心的后端小伙伴帮忙对接云平台，但后来他离职了，时运不济命途多舛。
