# 提高易用性的 HOC

- withReactLazy 怎么封装的？
  一般写 React.lazy 写的时候需要有四个点，import 语句、 suspense，fallback 。这四个点里面，只有 import 语句必须得是开发者自己写，像 suspense 和 fallback 因为写法非常的单一，所以可以进行结合，这样一个简单的 HOC 就完成了，当然还可能需要处理一下 ref ，另外为了能更好的支持类型推导，还需要做一些 TS 范型的处理。这只是一个最基本的 HOC 封装，还可以再接着这个基础的 lazy HOC 思路进行扩展延伸。比如 lazy 后的组件不论他展示与否都是要进行异步加载的，但我们可以结合 IntersectionObserver/或 scroll 事件，在代码分割的基础上实现组件的懒加载，，也可以再结合 ErrorBoundary 来处理模块报错。

  相对于开发者自己去写 lazy/suspense/fallback，这样的封装能够减少一些样板代码，有的开发者可能就是因为需要写这些样板代码才不愿意去使用 lazy，这样的封装能够让开发者更愿意去使用 lazy。当然，代价就是 HOC 封装比较抽象，有一些理解成本。

- withSkeleton 怎么封装的？
  接收两个参数，第一个是组件，第二个是判断方法，思路大致类似于 React.lazy 的，就是对原来的组件 props 进行一个劫持，通过判断方法来决定是否展示骨架屏。但是这里有一个限制条件，就是组件数据必须通过 props 传递才可以。

- 问题？
  其实问题不是特别多，可能会导致开发者插件的展示上不够友好，但我们做的时候尽量把 displayname 这种静态变量用起来。
  对于原始组件的一些静态方法属性也需要继承过来 hoist-non-react-statics
  当然也不一定非得用 HOC 的方式，hooks\cloneElement 都是不错的选择。其实网上说的 hoc 的优势 渲染劫持 属性代理啊，喜欢讲一些名词搞的很神秘一样，我还没有遇到过那种 HOC 可以但 HOOKS 或其他方式无法实现的场景，针对某一场景用某个方式写起来比其他方式更爽的情况时候，我就会选择这种方式，仅此而已。

# 楼盘户室号选择

- 您是觉得这些组件的写起来没什么挑战是吗？
  我还写过一些业务专用的组件，最近的一个是去年写的 autocomplete 联动搜索组件，组建需求的目的主要是为了提升经纪人选择楼盘、栋、单元、房号时的便捷性以及降低前端开发的使用成本。在我们做房产业务的人眼里，这是一个比较核心的功能点。最基本的交互上是一行选择框，最少一个，最多四个，分别对应楼盘，和可选的栋、单元、房号进行排列组合，简单标记成 1234 号选择框，第一个功能点是，只有当前面的选择框完成后才可以进行后面的选择，并且后面的选择框的类型是由前面的选项来决定的排列组合。第二个功能点是，前面的选择框变更后，后面的也要一并清除，并且自动搜索并打开下一个选择框。这里有个潜在的条件是，每个选择框都得知道他前面都有什么选择框，并且拿到他们的值再去调接口获取选项；第三个功能点是能够当作 antd 的 FormItem 来直接使用，也就是支持定制化的表单项。这是三个核心的功能点，还有一些细枝末节的就不再说了，这个组件乍一听的时候，有点像级联选择器，类似面板的那种，但可惜不是，因为他不光可以选择，还允许手动输入，归根结底是巧房 SaaS 系统需求采集自经纪人，他想要啥样的我们就要做成啥样的。

- 其实拿到这个需求的时候我也很头大，因为我目前的工作重心主要在爱房，因为巧房团队的组件开发大部分都是自己认领的，我万万没想到会被老板抓到巧房做这个组件。
- 设计思路
  我一开始的设计思路很朴素，就是是一个容器包含四个选择框，然后进行状态控制，但是我很快就发现这样设计的话复杂度会异常的高。因为对于每一个选择框来说，它的显示隐藏是由前一个来决定的，查询条件需要前面选择框的值，并且还得能够控制后面选择框。如果我硬要采用朴素的方式来写其实也能实现，但这样实现的话几乎是没有任何扩展性的，状态控制也比较多，节点的类型、显示隐藏、访问前后节点的能力，考虑到后面的迭代维护对任何人来说都是比较痛苦的。就算设计方案通过大家的考验了，代码 review 阶段肯定也很困难。然后我就想了第二个方案，主要的改动点是加入了双向链表结构，每一个选择框对应一个节点，链表的长度可以动态决定，每个节点都可以访问它的前驱和后驱。这样我只需要开发两个组件就好，一个是容器组件，一个是 item 组件，容器组件负责维护链表以及控制每个 item 的 select/search/focus/blur 动作，然后通过遍历链表去渲染 item，item 其实就是一个比较原始的 antd select 组件，主要是使用链表节点上存放的一些属性，并且传递 ref，以及做一些默认值的处理。其实到这里就会明显的感觉到整个组件的开发难度下降了很多。而且这个组件的扩展性也非常好，应用场景不会局限在楼盘户室号选择这一个地方，总的来说还是一次比较成功的组件开发，利用数据结构降低开发复杂度。
  因为是去年开发的，再具体的细节就记不太清了。

# 静态网页加工

- sketch 转 html 这个是北京那边人搞出来的，他的技术实现我没有看过，不清楚。
- 这个东西是一个 sketch 插件，主要是提供给 UED 设计使用的。这个插件可以导出 html。但是问题在于，ued 导出 html 后需要上线又不具备这样的技能，所以就需要找开发来上线，最开始前端也只是单纯的上传到 cdn 就好。但后来产品又需要统计一下数据，要求能够进行埋点。这个时候我就意识到产品未来可能要的越来越多，于是就想着做这样一个 html 预处理工具，能够对纯静态的 html 进行自定义的预处理操作。其实就是利用正则工具针对字符串进行匹配转换，只是转换的种类比较多，比如埋点，就是在页面中添加一个相对路径的 script，然后在对应的 js 文件中添加写好的埋点代码，使用者只需要在 js 中改改参数就好。再比如图片懒加载，其实就是匹配 img src 标签，然后替换成 data-src ，再在 head 中添加图片懒加载的脚本。还有 video 的处理，就是利用第三方的播放插件进行 video 标签设置 mediaelementplayer，让他在 webview 中也能进行比较好的交互。
- 这个工具是我 20 年写的，那个时候刚入职不到一年，写的也比较粗糙。后来我们组里来应届生的时候，一般都会让他先用这个工具来上线一个网页，操作不难，比较容易获得成就感，是一个比较好的试金石。
